name: CI

on:
  push:
    branches: [ main ]
    paths-ignore: ./build

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v2
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v2.1.2
        with:
          # Version Spec of the version to use.  Examples: 12.x, 10.15.1, >=10.15.0
          node-version: 12.x
          # Set this option if you want the action to check for the latest available version that satisfies the version spec
          check-latest: true

      - name: Setup gulp
        run: npm install gulp-cli
      
      - name: Package UI
        run: gulp bundle
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3.4.1
        with:
          path: ./build
          branch: github-action/update-bundle
          delete-branch: true
          
  merge:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Merge me!
        uses: ridedott/merge-me-action@master
        with:
          # Depending on branch protection rules, a  manually populated
          # `GITHUB_TOKEN_WORKAROUND` environment variable with permissions to
          # push to a protected branch must be used. This variable can have an
          # arbitrary name, as an example, this repository uses
          # `GITHUB_TOKEN_DOTTBOTT`.
          #
          # When using a custom token, it is recommended to leave the following
          # comment for other developers to be aware of the reasoning behind it:
          #
          # This must be used as GitHub Actions token does not support
          # pushing to protected branches.
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

  publish:
    needs: merge
    runs-on: ubuntu-latest
    
    steps:
      # This step dispatches an event to run the CI workflow of plenty-developers-docs
      - name: Rebuild site
        run: |
          curl -X POST https://api.github.com/repos/plentymarkets/plenty-developers-docs/dispatches \
          -H 'Accept: application/vnd.github.v3+json' \
          -u ${{ secrets.ACCESS_TOKEN }} \
          --data '{"event_type": "UIBundleUpdate", "client_payload": { "repository": "'"$GITHUB_REPOSITORY"'" }}'
